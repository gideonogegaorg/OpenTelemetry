name: CI

on:
  push:
    branches: [main, dev]
  pull_request:
    branches: [main, dev]

jobs:
  lint:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: "10.0.x"
      - name: Install dotnet-format
        run: dotnet tool install -g dotnet-format
      - name: Verify format
        run: dotnet format src/GMO.OpenTelemetry.sln --verify-no-changes

  build:
    runs-on: ubuntu-latest
    needs: [lint]
    outputs:
      assembly_version: ${{ steps.setversion.outputs.assembly_version }}
      dll_version: ${{ steps.setversion.outputs.dll_version }}
    steps:
      - uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: "10.0.x"

      - name: Set version
        id: setversion
        run: |
          YEAR=$(date +%Y)
          MONTH=$(date +%m)
          RUN_ID=${{ github.run_id }}
          BUILD=$(( RUN_ID % 65535 ))
          REVISION=$(( (RUN_ID / 65535) % 65535 ))
          ASSEMBLY_VERSION="$YEAR.$MONTH.$BUILD.$REVISION"
          if [ "${{ github.ref_name }}" = "dev" ]; then
            DLL_VERSION="DEV-$(date +%Y%m)$RUN_ID"
          else
            DLL_VERSION="$(date +%Y%m)$RUN_ID"
          fi
          echo "ASSEMBLY_VERSION=$ASSEMBLY_VERSION" >> $GITHUB_ENV
          echo "DLL_VERSION=$DLL_VERSION" >> $GITHUB_ENV
          echo "assembly_version=$ASSEMBLY_VERSION" >> $GITHUB_OUTPUT
          echo "dll_version=$DLL_VERSION" >> $GITHUB_OUTPUT

      - name: Restore
        run: dotnet restore src/GMO.OpenTelemetry.sln

      - name: Build
        run: |
          dotnet build src/GMO.OpenTelemetry.sln -c Release --no-restore \
            -p:Version=${{ env.ASSEMBLY_VERSION }} \
            -p:AssemblyVersion=${{ env.ASSEMBLY_VERSION }} \
            -p:FileVersion=${{ env.ASSEMBLY_VERSION }} \
            -p:InformationalVersion=${{ env.DLL_VERSION }}

  test:
    runs-on: ubuntu-latest
    needs: [build]
    steps:
      - uses: actions/checkout@v4
      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: "10.0.x"
      - name: Restore
        run: dotnet restore src/GMO.OpenTelemetry.sln
      - name: Build
        run: |
          dotnet build src/GMO.OpenTelemetry.sln -c Release --no-restore \
            -p:Version=${{ needs.build.outputs.assembly_version }} \
            -p:AssemblyVersion=${{ needs.build.outputs.assembly_version }} \
            -p:FileVersion=${{ needs.build.outputs.assembly_version }} \
            -p:InformationalVersion=${{ needs.build.outputs.dll_version }}
      - name: Test
        run: |
          set +e
          dotnet test src/GMO.OpenTelemetry.sln -c Release --no-build --verbosity normal 2>&1 | tee test.log
          EXIT=$?
          if [ $EXIT -ne 0 ] && grep -qi "no test is available\|no test matched" test.log; then
            echo "No test projects yet; step passes until tests are added."
            exit 0
          fi
          exit $EXIT

  tag:
    if: github.event_name == 'push'
    runs-on: ubuntu-latest
    needs: [test]
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4
      - name: Create and push tag
        run: |
          TAG_NAME="${{ github.ref_name }}-$(date +%Y)-$(date +%m)-${{ github.run_id }}"
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git tag "$TAG_NAME"
          git push origin "$TAG_NAME"

  publish:
    if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/dev')
    runs-on: ubuntu-latest
    needs: [build, tag]
    permissions:
      contents: read
      packages: write
    steps:
      - uses: actions/checkout@v4
      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: "10.0.x"
      - name: Pack
        run: |
          if [ "${{ github.ref_name }}" = "dev" ]; then
            PACKAGE_VERSION="${{ needs.build.outputs.assembly_version }}-alpha"
          else
            PACKAGE_VERSION="${{ needs.build.outputs.assembly_version }}"
          fi
          dotnet pack src/GMO.OpenTelemetry.sln -c Release -o nupkgs \
            -p:PackageVersion=$PACKAGE_VERSION \
            -p:Version=${{ needs.build.outputs.assembly_version }} \
            -p:AssemblyVersion=${{ needs.build.outputs.assembly_version }} \
            -p:FileVersion=${{ needs.build.outputs.assembly_version }} \
            -p:InformationalVersion=${{ needs.build.outputs.dll_version }}
      - name: Push to GitHub Packages
        run: |
          for pkg in nupkgs/*.nupkg; do
            dotnet nuget push "$pkg" --api-key "${{ secrets.GH_CLASSIC_PAT }}" --source "https://nuget.pkg.github.com/${{ github.repository_owner }}/index.json"
          done
